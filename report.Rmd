---
title: "The MTA Versus Citi Bike"
author: "Jessica Padilla"
date: "September 27, 2019"
output:
  pdf_document: default
---

## Introduction

The Metropolitan Transportation Authority (MTA) is responsible for overseeing the transportation network throughout New York City and its surrounding regions.  The MTA consists of New York City Transit, Long Island Railroad, Metro-North Railroad, Staten Island Railway, Regional Bus Operations, and B&T (Bridges and Tunnels).  For this project, we focus on the New York City Transit subways provided by the MTA.

In 1979, the subway system was completely deteoriated.  In order to revive the system, the MTA needed more funds than the State of New York could provide annually.  As a result, the MTA continuously sold bonds and took on several loans to rebuild infrastructure, in hopes that the debt would eventually be paid off by fare revenue.  However, many decades later, there is a decrease in subway ridership, and the MTA debt is approaching 42 billion dollars.  But why is subway ridership declining?  Is the MTA to blame, or are people looking to other forms of transportation?

In 2013, a bike share program called Citi Bike was launched throughout NYC.  Citi Bike allows people to borrow bikes and pay either on an hourly basis, daily basis, or through an annual membership.  Because it is eco-friendly in nature, user-friendly, and very affordable, it has attracted thousands of people throughout the city.  Several years later after its launch, the number of Citi Bike users continues to increase and shows no sign of slowing down.

Here we discuss how the decrease in subway ridership is correlated to the increase in Citi Bike services.  We also provide suggestions on how MTA finances can be re-allocated to help subways remain competitive in the transporation industry.

&nbsp;

## Methods

Annual and average subway ridership totals were retrieved from the MTA web site (http://web.mta.info/nyct/facts/ridership/) through web scraping.  This involved extracting text and tables from the html code within the web page and converting them into data tables.  To obtain a breakdown of monthly ridership totals, data from 144 .txt files were imported from the MTA web site (http://web.mta.info/developers/turnstile.html)  using the readr package within R.

Information in regards to MTA subway services was obtained through the "Performance Dashboard" of the MTA web site (http://dashboard.mta.info).  Data was retrieved from a total of 4 .csv files.

MTA budget and revenue data were found through the "MTA Fiscal Dashboard" of the Citizens Budget Commission web site (https://cbcny.org/research/mta-fiscal-dashboard).  Data was exported from the site into 3 .csv files. 

Citi Bike data was retrieved from the official Citi Bike web site (https://www.citibikenyc.com/system-data).  All quarterly data was exported from a total of 22 .csv files.

All of the data was, then, imported into R.  Data was filtered to only include information pertaining to the subway system and Citi Bike.  It was also filtered up to and including the year 2018, since the year 2019 is not yet completed.  Wrangling was, then, performed to clean any relevant data and format it for further analysis.  After the data was cleaned, all of the subway and Citi Bike ridership data was merged into one table.  This was done using the functions from the tidyverse package within R.

The ggplot2 package was used within R as the primary tool for data visualization techniques.  Graphs generated with this package were used to demonstrate trends and new findings.



## Results

The debt of the MTA has grown significantly over the years and is project to reach $42 billion by the year 2022.  While fare revenue has been able to offset a bit of the debt, fare revenue has reached a standstill.  Data obtained from the MTA Fiscal Dashboard (courtest of the Citizens Budget Commission) shows that although the fare revenue is much larger than what it was in 2007, the amount of fare revenue has slowed down since 2013.  In fact, there was a slight decrease in fare revenue in 2018.

&nbsp;

```{r, subway fare revenue, echo = FALSE, message = FALSE, results = 'hide', fig.height = 3.65}

## load libraries
library(tidyverse)
library(rvest)
library(lubridate)
library(gridExtra)

## retrieve the mta revenue data
mta_revenue <- read_csv("https://github.com/jessicapadilla/mta_citi_uber/raw/master/mta_revenue.csv")

## check the structure of the mta revenue table
str(mta_revenue)

## remove unwanted columns and rename some columns
mta_revenue <- mta_revenue %>% select(-c("Fifty2525", "Date Prefix", 
                                         "Revenue Type Note", "Adjustments Outcome",
                                         "No-Adjustments Value", "Date",
                                         "Framework Selection Calculation")) %>%
  rename(Business_Line_Group = 'Business Line (group)',
         Business_Line = 'Business Line',
         Revenue_Description = Description1,
         Revenue_Type = 'Revenue and Expense Type',
         Revenue_Cost = Value)

## change all NA values to 0
mta_revenue[is.na(mta_revenue)] = 0

## check the mta revenue table
head(mta_revenue)

## create a graph for subway revenue totals each year
## exclude year 2019 since the year is not yet completed
mta_revenue %>% filter(Year <= 2018 & Revenue_Description == "Subway") %>%
  ggplot(aes(Year, Revenue_Cost)) + 
  geom_bar(stat = "identity", fill = "black") +
  scale_x_continuous(breaks = seq(2007, 2018, 1)) + 
  coord_cartesian(ylim = c(1500, 3500)) +
  xlab("Year") + ylab("Total Revenue (millions)") +
  ggtitle("MTA Subway Fare Revenue") + 
  theme_bw()
```

If we focus between the years 2013 and 2018, we see that this is due to the decrease in subway ridership throughout the entire week.  Both weekend and weekday ridership numbers are at their lowest in 2018.

```{r, subway ridership,  echo = FALSE, message = FALSE, results = 'hide', fig.height = 3.65}
## retrieve subway ridership data
subway_riders_url <- "http://web.mta.info/nyct/facts/ridership/"

## get the html code
subway_riders_html <- read_html(subway_riders_url)

## get the html nodes
subway_riders_table <- subway_riders_html %>% html_nodes("table")

## check the html nodes
subway_riders_table

## find the subway table
subway_riders_table[[2]]

## turn the table to a data frame
subway_riders <- subway_riders_table[[2]] %>% html_table

## check the structure of the subway ridership data
str(subway_riders)

## change the year column to numbers
subway_riders[,1] <- subway_riders[,1] %>% as.numeric()

## remove the commas from the remaining columns and convert them to numbers
subway_riders[,2] <- subway_riders[,2] %>% str_replace_all(",","") %>% as.numeric()
subway_riders[,3] <- subway_riders[,3] %>% str_replace_all(",","") %>% as.numeric()
subway_riders[,4] <- subway_riders[,4] %>% str_replace_all(",","") %>% as.numeric()
subway_riders[,5] <- subway_riders[,5] %>% str_replace_all(",","") %>% as.numeric()
subway_riders[,6] <- subway_riders[,6] %>% str_replace_all(",","") %>% as.numeric()

## convert the data to a tibble
subway_riders <- subway_riders %>% as_tibble()

## rename the columns
subway_riders <- subway_riders %>% 
  rename(Average_Weekdays = `Average Weekday`,
         Average_Saturdays = `Average Saturday`,
         Average_Sundays = `Average Sunday`,
         Average_Weekends = `Average Weekend`,
         Annual_Total = `Annual Total`)

## check the table
head(subway_riders)

## gather the subway riders data
subway_riders <- subway_riders %>% 
  gather(Category, Riders, Average_Weekdays:Annual_Total)

## create a graph showing the average number of riders on weekdays
weekdays <- subway_riders %>% filter(Category == "Average_Weekdays") %>%
  ggplot(aes(Year, Riders)) + 
  geom_point(color = "red", show.legend = FALSE) + 
  geom_line(color = "red", show.legend = FALSE) + 
  coord_cartesian(ylim = c(5400000, 5700000)) +
  xlab("Year") + ylab("Average Number of Riders") + ggtitle("Weekdays") +
  theme_bw()

## create a graph showing the average number of riders on weekends
weekends <- subway_riders %>% filter(Category == "Average_Weekends") %>%
  ggplot(aes(Year, Riders, col = )) + 
  geom_point(color = "purple", show.legend = FALSE) + 
  geom_line(color = "purple", show.legend = FALSE) + 
  coord_cartesian(ylim = c(5400000, 6000000)) +
  xlab("Year") + ylab("Average Number of Riders") + ggtitle("Weekends") +
  theme_bw()
                         
## put the graphs side by side
grid.arrange(weekdays, weekends, ncol = 2)
```

