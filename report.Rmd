---
title: "The MTA Versus Citi Bike and Uber"
author: "Jessica Padilla"
date: "September 27, 2019"
output:
  pdf_document: default
---

## Introduction

The Metropolitan Transportation Authority (MTA) is responsible for overseeing the transportation network throughout New York and its surrounding regions.  The MTA consists of New York City Transit, Long Island Railroad, Metro-North Railroad, Staten Island Railway, Regional Bus Operations, and B&T (Bridges and Tunnels).  For this project, we focus on the the subways provided by the MTA.

In 1979, the subway system was completely deteoriated.  In order to revive the system, the MTA needed more funds than the State of New York could provide annually.  As a result, the MTA continuously sold bonds and took on several loans to rebuild infrastructure, in hopes that the debt would eventually be paid off by fare revenue.  However, many decades later, there is a decrease in subway ridership, and the MTA debt is approaching 42 billion dollars.  But why is subway ridership declining?  Is the MTA to blame, or are people looking to other forms of transportation?

In 2011, Uber was launched in New York City.  Uber is a ride service company, where people can request trips through the ease of a phone app.

Furthermore, in 2013, a bike share program called Citi Bike was launched throughout NYC.  Citi Bike allows people to pay either on an hourly basis, daily basis, or through an annual membership.  

Here we discuss how the decrease in subway ridership is correlated to the increase in Citi Bike and Uber services.  We also provide suggestions on how MTA finances can be re-allocated to help subways remain competitive in the transporation industry.



## Methods

Information in regards to MTA subway services was obtained through the "Performance Dashboard" of the official MTA web site (http://dashboard.mta.info).  Data was exported from the site in the form of .csv files.

Subway ridership information was also retrieved from the MTA web site (http://web.mta.info/nyct/facts/ridership/).  However, since no export option was available, data was extracted using web scraping.  This method involves extracting text and tables from the html code that generates the web page.  This was done by using the rvest package within R.

MTA budget and revenue data were found on the "MTA Fiscal Dashboard" of the Citizens Budget Commission web site (https://cbcny.org/research/mta-fiscal-dashboard).  Since no export option was available, this data was also extracted using web scraping.  

Citi Bike data was retrieved from the official Citi Bike web site (https://www.citibikenyc.com/system-data).  All data was exported in the form of .csv files.

Uber ridership data was obtained from the NYC OpenData site (https://data.cityofnewyork.us/Transportation/FHV-Base-Aggregate-Report/2v9c-2k7f/data).  Information pertaining to Uber was specifically found in the FHV Base Aggregate Report found on the site.

All of the data was, then, imported into R.

Data was filtered to only include information pertaining to the subway system, Citi Bike, and Uber.  Wrangling was performed to clean any relevant data and format it for further analysis.

The ggplot2 package was used within R as the primary tool for data visualization techniques.  Graphs generated with this package were used to clarify trends and demonstrate new findings.  


## Results

The debt of the MTA has grown significantly over the years and is project to reach $42 billion by the year 2022.  While fare revenue has been able to offset a bit of the debt, fare revenue has reached a standstill.  Data obtained from the MTA Fiscal Dashboard (courtest of the Citizens Budget Commission) shows that although the fare revenue is much larger than what it was in 2007, the amount of fare revenue has slowed down since 2013.  In fact, there was a slight decrease in fare revenue in 2018.


```{r, subway fare revenue, echo = FALSE, message = FALSE, results = 'hide', fig.height = 3.65}
## load libraries
library(tidyverse)
library(rvest)

## retrieve the mta revenue data
mta_revenue <- read_csv("https://github.com/jessicapadilla/mta_citi_uber/raw/master/mta_revenue.csv")

## check the structure of the mta revenue table
str(mta_revenue)

## remove unwanted columns and rename some columns
mta_revenue <- mta_revenue %>% select(-c("Fifty2525", "Date Prefix", 
                                         "Revenue Type Note", "Adjustments Outcome",
                                         "No-Adjustments Value", "Date",
                                         "Framework Selection Calculation")) %>%
  rename(Business_Line_Group = 'Business Line (group)',
         Business_Line = 'Business Line',
         Revenue_Description = Description1,
         Revenue_Type = 'Revenue and Expense Type',
         Revenue_Cost = Value)

## change all NA values to 0
mta_revenue[is.na(mta_revenue)] = 0

## check the mta revenue table
head(mta_revenue)

## create a graph for subway revenue totals each year
## exclude year 2019 since the year is not yet completed
mta_revenue %>% filter(Year <= 2018 & Revenue_Description == "Subway") %>%
  ggplot(aes(Year, Revenue_Cost)) + 
  geom_bar(stat = "identity", fill = "black") +
  scale_x_continuous(breaks = seq(2007, 2018, 1)) + 
  coord_cartesian(ylim = c(1500, 3500)) +
  xlab("Year") + ylab("Total Revenue (millions)") +
  ggtitle("MTA Subway Fare Revenue") + 
  theme_bw()
```
If we focus between the years 2013 and 2018, we see that this is due to the decrease in subway ridership throughout the entire week.  Both weekend and weekday ridership numbers are at their lowest in 2018.

```{r, subway ridership,  echo = FALSE, message = FALSE, results = 'hide', fig.height = 3.65}
## retrieve subway ridership data
subway_riders_url <- "http://web.mta.info/nyct/facts/ridership/"

## get the html code
subway_riders_html <- read_html(subway_riders_url)

## get the html nodes
subway_riders_table <- subway_riders_html %>% html_nodes("table")

## check the html nodes
subway_riders_table

## find the subway table
subway_riders_table[[2]]

## turn the table to a data frame
subway_riders <- subway_riders_table[[2]] %>% html_table

## check the structure of the subway ridership data
str(subway_riders)

## change the year column to numbers
subway_riders[,1] <- subway_riders[,1] %>% as.numeric()

## remove the commas from the remaining columns and convert them to numbers
subway_riders[,2] <- subway_riders[,2] %>% str_replace_all(",","") %>% as.numeric()
subway_riders[,3] <- subway_riders[,3] %>% str_replace_all(",","") %>% as.numeric()
subway_riders[,4] <- subway_riders[,4] %>% str_replace_all(",","") %>% as.numeric()
subway_riders[,5] <- subway_riders[,5] %>% str_replace_all(",","") %>% as.numeric()
subway_riders[,6] <- subway_riders[,6] %>% str_replace_all(",","") %>% as.numeric()

## convert the data to a tibble
subway_riders <- subway_riders %>% as_tibble()

## rename the columns
subway_riders <- subway_riders %>% 
  rename(Weekdays = `Average Weekday`,
         Saturdays = `Average Saturday`,
         Sundays = `Average Sunday`,
         Weekends = `Average Weekend`)

## spread the subway riders table by creating a ridership category
subway_riders <- subway_riders %>% 
  gather(Ridership_Category, Average_Riders, 'Weekdays':'Annual Total')

## arrange the ridership category in descending order
subway_riders <- subway_riders %>% 
  mutate(Ridership_Category = reorder(Ridership_Category, -Average_Riders))

## check the table
head(subway_riders)

## create a graph for subway ridership
subway_riders %>% 
  filter(Ridership_Category == "Weekdays" | 
           Ridership_Category == "Weekends") %>%
  ggplot(aes(Year, Average_Riders)) + 
  geom_bar(stat = "identity", fill = "black") + 
  scale_x_continuous(breaks = seq(2013, 2018, 1)) + 
  coord_cartesian(ylim = c(3500000, 6000000)) +
  xlab("Year") + ylab("Average Number of Riders") +
  ggtitle("Subway Ridership") +
  facet_wrap(~Ridership_Category) + theme_bw()
```

